name: Verify PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: files
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff --name-status origin/${{ github.base_ref }} > changes.txt
          cat changes.txt

      - name: Validate changes
        run: |
          set -e

          USER="${{ github.actor }}"
          RESERVED="reserved.txt"

          # Load reserved root-level names
          if [ -f "$RESERVED" ]; then
            mapfile -t RESERVED_NAMES < "$RESERVED"
          else
            RESERVED_NAMES=()
          fi

          while read status file; do
            echo "Checking $status $file"

            # 1️⃣ Block workflow edits
            if [[ "$file" =~ ^.github/ ]]; then
              echo "❌ Editing workflow files is not allowed"
              exit 1
            fi

            # 2️⃣ Block reserved.txt edits
            if [[ "$file" == "$RESERVED" ]]; then
              echo "❌ Editing reserved.txt is not allowed"
              exit 1
            fi

            # 3️⃣ Must be inside user's folder if inside records/
            if [[ "$file" =~ ^records/ ]]; then
              if [[ ! "$file" =~ ^records/$USER/[^/]+\.json$ ]]; then
                echo "❌ Files inside records/ must be in your own folder: records/$USER/"
                exit 1
              fi
            fi

            # 4️⃣ Only allow CRUD on user's own folder
            # Status can be: A=added, M=modified, D=deleted
            if [[ "$file" =~ ^records/$USER/ ]]; then
              if [[ ! "$status" =~ ^(A|M|D)$ ]]; then
                echo "❌ Only add, modify, or delete allowed in your folder"
                exit 1
              fi

              # If file exists (added or modified), validate JSON & reserved subdomain
              if [[ "$status" != "D" ]]; then
                jq . "$file" > /dev/null || { echo "❌ Invalid JSON in $file"; exit 1; }

                SUB=$(jq -r '.subdomain' "$file")
                for r in "${RESERVED_NAMES[@]}"; do
                  if [ "$SUB" = "$r" ]; then
                    echo "❌ Subdomain '$SUB' is reserved at root level"
                    exit 1
                  fi
                done
              fi
            fi

          done < changes.txt

          echo "✅ All checks passed"
